{% extends "admin/base_site.html" %}
{% load static crispy_forms_tags %}

{% block title %}{{ title }} | {{ site_title }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="{% url 'admin:jsi18n' %}"></script>
{{ update_contact_form.media }}
{{ update_schedule_form.media }}
{{ change_transport_form.media }}
{{ archive_form.media }}
<style>
.courier-status { padding: 5px 12px; border-radius: 3px; font-weight: bold; text-transform: uppercase; }
.status-free { background: #28a745; color: white; }
.status-busy { background: #ffc107; color: #000; }
.status-unavailable { background: #6c757d; color: white; }
.status-archived { background: #dc3545; color: white; }
.inline-form { display: inline-block; margin-right: 5px; }
.action-buttons { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--hairline-color); }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'couriers:list' %}">Courier Management</a>
    &rsaquo; {{ courier.name }}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <fieldset class="module aligned">
        <h2>Status: <span class="courier-status status-{{ courier.status|lower }}">{{ courier.status }}</span></h2>
        <div class="form-row action-buttons">
            {% if courier.status == 'UNAVAILABLE' %}
            <form method="post" action="{% url 'couriers:activate' courier_id=courier.courier_id %}" class="inline-form">
                {% csrf_token %}
                <input type="submit" value="Activate" class="default">
            </form>
            {% elif courier.status == 'FREE' %}
            <form method="post" action="{% url 'couriers:deactivate' courier_id=courier.courier_id %}" class="inline-form">
                {% csrf_token %}
                <input type="submit" value="Deactivate" class="default">
            </form>
            {% endif %}
            {% if courier.status != 'ARCHIVED' %}
            <input type="button" value="Archive..." class="default" onclick="document.getElementById('archive-modal').style.display='block'">
            {% endif %}
        </div>
    </fieldset>

    <fieldset class="module aligned">
        <h2>Courier Information</h2>
        <div class="form-row"><div><label>ID:</label> <code>{{ courier.courier_id }}</code></div></div>
        <div class="form-row"><div><label>Name:</label> {{ courier.name }}</div></div>
        <div class="form-row"><div><label>Phone:</label> {{ courier.phone }}</div></div>
        <div class="form-row"><div><label>Email:</label> {{ courier.email }}</div></div>
        <div class="form-row"><div><label>Transport:</label> {{ courier.transport_type }}</div></div>
        <div class="form-row"><div><label>Zone:</label> {{ courier.work_zone|default:"-" }}</div></div>
        <div class="form-row"><div><label>Max Distance:</label> {{ courier.max_distance_km }} km</div></div>
        <div class="form-row"><div><label>Work Hours:</label> {% if courier.work_hours %}{{ courier.work_hours.start_time }} - {{ courier.work_hours.end_time }} (Days: {{ courier.work_hours.work_days|join:", " }}){% else %}-{% endif %}</div></div>
    </fieldset>

    <fieldset class="module aligned">
        <h2>Performance</h2>
        <div class="form-row"><div><label>Current Load:</label> {{ courier.current_load }}/{{ courier.max_load }} packages</div></div>
        <div class="form-row"><div><label>Rating:</label> {% if courier.rating > 0 %}{{ courier.rating|floatformat:1 }}/5.0{% else %}No rating yet{% endif %}</div></div>
        <div class="form-row"><div><label>Successful:</label> {{ courier.successful_deliveries }}</div></div>
        <div class="form-row"><div><label>Failed:</label> {{ courier.failed_deliveries }}</div></div>
        <div class="form-row"><div><label>Created:</label> {{ courier.created_at }}</div></div>
        <div class="form-row"><div><label>Last Active:</label> {{ courier.last_active_at|default:"-" }}</div></div>
    </fieldset>

    {% if courier.current_location %}
    <fieldset class="module aligned">
        <h2>Current Location</h2>
        <div class="form-row">
            <div><label>Coordinates:</label> {{ courier.current_location.latitude|floatformat:6 }}, {{ courier.current_location.longitude|floatformat:6 }}</div>
        </div>
        <div class="form-row">
            <div id="courier-map" style="height: 300px; margin-top: 10px;"></div>
        </div>
    </fieldset>
    {% endif %}

    {% if courier.status != 'ARCHIVED' %}
    <fieldset class="module aligned collapse">
        <h2>Update Contact Info</h2>
        <form method="post" action="{% url 'couriers:update_contact' courier_id=courier.courier_id %}">
            {% csrf_token %}
            <div class="flex flex-col gap-4">
                {% crispy update_contact_form "unfold_crispy" %}
            </div>
            <div class="form-row mt-4">
                <input type="submit" value="Update Contact" class="default">
            </div>
        </form>
    </fieldset>

    <fieldset class="module aligned collapse">
        <h2>Update Work Schedule</h2>
        <form method="post" action="{% url 'couriers:update_schedule' courier_id=courier.courier_id %}">
            {% csrf_token %}
            <div class="flex flex-col gap-4">
                {% crispy update_schedule_form "unfold_crispy" %}
            </div>
            <div class="form-row mt-4">
                <input type="submit" value="Update Schedule" class="default">
            </div>
        </form>
    </fieldset>

    <fieldset class="module aligned collapse">
        <h2>Change Transport Type</h2>
        <form method="post" action="{% url 'couriers:change_transport' courier_id=courier.courier_id %}">
            {% csrf_token %}
            <div class="flex flex-col gap-4">
                {% crispy change_transport_form "unfold_crispy" %}
            </div>
            <p class="help">Changing transport type will reset current load to 0 and update max load capacity.</p>
            <div class="form-row mt-4">
                <input type="submit" value="Change Transport" class="default">
            </div>
        </form>
    </fieldset>
    {% endif %}

    <div class="submit-row">
        <p class="deletelink-box"><a href="{% url 'couriers:list' %}">Back to list</a></p>
    </div>
</div>

<!-- Archive Modal -->
<div id="archive-modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
    <div style="background:var(--body-bg); margin:10% auto; padding:20px; border-radius:4px; width:500px; max-width:90%;">
        <h2>Archive Courier</h2>
        <p>Are you sure you want to archive <strong>{{ courier.name }}</strong>?</p>
        <form method="post" action="{% url 'couriers:archive' courier_id=courier.courier_id %}">
            {% csrf_token %}
            <div class="flex flex-col gap-4">
                {% crispy archive_form "unfold_crispy" %}
            </div>
            <div class="submit-row mt-4">
                <input type="submit" value="Archive" class="default deletelink">
                <input type="button" value="Cancel" onclick="document.getElementById('archive-modal').style.display='none'">
            </div>
        </form>
    </div>
</div>

{% if courier.current_location %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    var map = L.map('courier-map').setView([{{ courier.current_location.latitude }}, {{ courier.current_location.longitude }}], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    L.marker([{{ courier.current_location.latitude }}, {{ courier.current_location.longitude }}])
        .addTo(map)
        .bindPopup('<strong>{{ courier.name|escapejs }}</strong><br>{{ courier.status|escapejs }}')
        .openPopup();
});
</script>
{% endif %}
{% endblock %}
