{% extends "admin/base_site.html" %}
{% load static i18n unfold %}

{% block title %}{{ title }} | {{ site_title }}{% endblock %}

{% block breadcrumbs %}{% if not is_popup %}
<div class="px-4">
    <div class="container mb-6 mx-auto -my-3 lg:mb-12">
        <ul class="flex flex-wrap">
            {% url 'admin:index' as link %}
            {% trans 'Home' as name %}
            {% include 'unfold/helpers/breadcrumb_item.html' with link=link name=name %}

            {% url 'couriers:list' as link %}
            {% trans 'Courier Management' as name %}
            {% include 'unfold/helpers/breadcrumb_item.html' with link=link name=name %}

            {% trans 'Map' as name %}
            {% include 'unfold/helpers/breadcrumb_item.html' with name=name %}
        </ul>
    </div>
</div>
{% endif %}{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<style>
#courier-map {
    height: calc(100vh - 200px);
    min-height: 500px;
    width: 100%;
    border-radius: 4px;
}
.courier-popup {
    min-width: 200px;
}
.courier-popup h4 {
    margin: 0 0 10px 0;
    padding-bottom: 5px;
    border-bottom: 1px solid #ddd;
}
.courier-popup .status {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
    margin-bottom: 10px;
}
.courier-popup .status-free { background: #28a745; color: white; }
.courier-popup .status-busy { background: #ffc107; color: #000; }
.courier-popup table {
    width: 100%;
    font-size: 12px;
}
.courier-popup table td {
    padding: 3px 0;
}
.legend {
    background: white;
    padding: 10px;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.legend-item {
    display: flex;
    align-items: center;
    margin: 5px 0;
}
.legend-marker {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-right: 8px;
}
.marker-free { background: #28a745; }
.marker-busy { background: #ffc107; }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>{{ title }}</h1>
        <div>
            <a href="{% url 'couriers:list' %}" class="viewlink">Back to List</a>
        </div>
    </div>

    <div class="module">
        <h2>Active Couriers ({{ couriers|length }})</h2>
        <div id="courier-map"></div>
    </div>

    {% if not couriers %}
    <p class="help" style="margin-top: 10px;">
        No couriers with location data available. Couriers will appear on the map when they share their location.
    </p>
    {% endif %}
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map centered on Berlin
    var map = L.map('courier-map').setView([52.520008, 13.404954], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Custom icons for different statuses
    var freeIcon = L.divIcon({
        className: 'courier-marker',
        html: '<div style="background: #28a745; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });

    var busyIcon = L.divIcon({
        className: 'courier-marker',
        html: '<div style="background: #ffc107; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });

    // Create marker cluster group
    var markers = L.markerClusterGroup();

    // Courier data from Django
    var couriers = [
        {% for courier in couriers %}
        {
            id: "{{ courier.courier_id|escapejs }}",
            name: "{{ courier.name|escapejs }}",
            status: "{{ courier.status|escapejs }}",
            transport: "{{ courier.transport_type|escapejs }}",
            load: "{{ courier.current_load }}/{{ courier.max_load }}",
            zone: "{{ courier.work_zone|escapejs }}",
            phone: "{{ courier.phone|escapejs }}",
            lat: {{ courier.current_location.latitude }},
            lng: {{ courier.current_location.longitude }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Add markers
    couriers.forEach(function(courier) {
        var icon = courier.status === 'FREE' ? freeIcon : busyIcon;
        var statusClass = courier.status.toLowerCase();

        var popupContent = `
            <div class="courier-popup">
                <h4>${courier.name}</h4>
                <span class="status status-${statusClass}">${courier.status}</span>
                <table>
                    <tr><td>Transport:</td><td>${courier.transport}</td></tr>
                    <tr><td>Load:</td><td>${courier.load} packages</td></tr>
                    <tr><td>Zone:</td><td>${courier.zone}</td></tr>
                    <tr><td>Phone:</td><td>${courier.phone}</td></tr>
                </table>
                <a href="/admin/couriers/${courier.id}/" style="display: block; margin-top: 10px; text-align: center;">View Details</a>
            </div>
        `;

        var marker = L.marker([courier.lat, courier.lng], { icon: icon })
            .bindPopup(popupContent);

        markers.addLayer(marker);
    });

    map.addLayer(markers);

    // Fit map to markers if there are any
    if (couriers.length > 0) {
        map.fitBounds(markers.getBounds(), { padding: [50, 50] });
    }

    // Add legend
    var legend = L.control({ position: 'bottomright' });
    legend.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
            <div class="legend-item">
                <div class="legend-marker marker-free"></div>
                <span>Free</span>
            </div>
            <div class="legend-item">
                <div class="legend-marker marker-busy"></div>
                <span>Busy</span>
            </div>
        `;
        return div;
    };
    legend.addTo(map);

    // Auto-refresh every 30 seconds
    setInterval(function() {
        location.reload();
    }, 30000);
});
</script>
{% endblock %}
