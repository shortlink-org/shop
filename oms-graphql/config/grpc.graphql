schema
@server(port: 8080, hostname: "0.0.0.0", enableFederation: true, introspection: true)
@upstream(
  allowedHeaders: ["Authorization", "user-id"]
)
@telemetry(
  export: {
    prometheus: {
      path: "/metrics"
      format: "text"
    }
  }
  requestHeaders: ["user-id", "Authorization"]
)
@link(type: Script, src: "scripts/auth.js")
@link(src: "{{.env.OMS_GRPC_URL}}", type: Grpc) {
  query: Query
  mutation: Mutation
}

# ============================================
# Cart Types
# ============================================

type CartItem {
  goodId: String
  quantity: Int
}

type CartState {
  cartId: String
  customerId: String
  items: [CartItem]
#  createdAt: String  # ISO8601 timestamp
#  updatedAt: String  # ISO8601 timestamp
}

type GetCartResponse {
  state: CartState
}

type CartRequest {
  customerId: String
}

# ============================================
# Order Types
# ============================================

type OrderItem {
  id: String
  quantity: Int
  price: Float
}

type DeliveryAddress {
  street: String
  city: String
  postalCode: String
  country: String
  latitude: Float
  longitude: Float
}

type DeliveryPeriod {
  startTime: Timestamp
  endTime: Timestamp
}

type PackageInfo {
  weightKg: Float
}

type RecipientContacts {
  recipientName: String
  recipientPhone: String
  recipientEmail: String
}

type DeliveryInfo {
  pickupAddress: DeliveryAddress
  deliveryAddress: DeliveryAddress
  deliveryPeriod: DeliveryPeriod
  packageInfo: PackageInfo
  priority: DeliveryPriority
  recipientContacts: RecipientContacts
}

type OrderState {
  id: String
  customerId: String
  items: [OrderItem]
  status: OrderStatus
  deliveryInfo: DeliveryInfo
}

type GetOrderResponse {
  order: OrderState
}

type Timestamp {
  seconds: Float
  nanos: Int
}

enum DeliveryPriority {
  DELIVERY_PRIORITY_UNSPECIFIED
  DELIVERY_PRIORITY_NORMAL
  DELIVERY_PRIORITY_URGENT
}

enum OrderStatus {
  ORDER_STATUS_UNSPECIFIED
  ORDER_STATUS_PENDING
  ORDER_STATUS_PROCESSING
  ORDER_STATUS_COMPLETED
  ORDER_STATUS_CANCELLED
}

type Query {
  # Cart queries
  getCart(customerId: CartRequest): GetCartResponse
  @grpc(
    url: "{{.env.OMS_GRPC_URL}}"
    method: "infrastructure.rpc.cart.v1.CartService.Get"
    body: "{{.args.customerId}}"
    headers: [
      {key: "Authorization", value: "{{.headers.Authorization}}"},
      {key: "user-id", value: "3e173751-8840-4b0d-8065-fbea88357cc5"}
    ]
  )

  # Order queries
  getOrder(id: String!): GetOrderResponse
  @grpc(
    url: "{{.env.OMS_GRPC_URL}}"
    method: "infrastructure.rpc.order.v1.OrderService.Get"
    body: "{\"id\": \"{{.args.id}}\"}"
    headers: [
      {key: "Authorization", value: "{{.headers.Authorization}}"},
      {key: "user-id", value: "3e173751-8840-4b0d-8065-fbea88357cc5"}
    ]
  )
}

# ============================================
# Cart Inputs
# ============================================

input ItemRequest {
  customerId: String!
  items: [CartItemInput!]!
}

input CartItemInput {
  goodId: String!
  quantity: Int!
}

# ============================================
# Order Inputs
# ============================================

input DeliveryAddressInput {
  street: String!
  city: String!
  postalCode: String
  country: String!
  latitude: Float
  longitude: Float
}

input DeliveryPeriodInput {
  startTime: String!
  endTime: String!
}

input PackageInfoInput {
  weightKg: Float!
}

input RecipientContactsInput {
  recipientName: String
  recipientPhone: String
  recipientEmail: String
}

input DeliveryInfoInput {
  pickupAddress: DeliveryAddressInput!
  deliveryAddress: DeliveryAddressInput!
  deliveryPeriod: DeliveryPeriodInput!
  packageInfo: PackageInfoInput!
  priority: String
  recipientContacts: RecipientContactsInput
}

input OrderItemInput {
  id: String!
  quantity: Int!
  price: Float!
}

input CreateOrderInput {
  customerId: String!
  items: [OrderItemInput!]!
  deliveryInfo: DeliveryInfoInput
}

input UpdateDeliveryInfoInput {
  orderId: String!
  deliveryInfo: DeliveryInfoInput!
}

input CheckoutInput {
  customerId: String!
  deliveryInfo: DeliveryInfoInput
}

type CheckoutResult {
  orderId: String
}

type Mutation {
  addItem(addRequest: ItemRequest): Empty!
  @grpc(
    url: "{{.env.OMS_GRPC_URL}}"
    method: "infrastructure.rpc.cart.v1.CartService.Add"
    body: "{{.args.addRequest}}"
    headers: [
      {key: "Authorization", value: "{{.headers.Authorization}}"},
      {key: "user-id", value: "3e173751-8840-4b0d-8065-fbea88357cc5"}
    ]
  )

  removeItem(removeRequest: ItemRequest): Empty!
  @grpc(
    url: "{{.env.OMS_GRPC_URL}}"
    method: "infrastructure.rpc.cart.v1.CartService.Remove"
    body: "{{.args.removeRequest}}"
    headers: [
      {key: "Authorization", value: "{{.headers.Authorization}}"},
      {key: "user-id", value: "3e173751-8840-4b0d-8065-fbea88357cc5"}
    ]
  )

  resetCart(customerId: CartRequest): Empty!
  @grpc(
    url: "{{.env.OMS_GRPC_URL}}"
    method: "infrastructure.rpc.cart.v1.CartService.Reset"
    body: "{{.args.customerId}}"
    headers: [
      {key: "Authorization", value: "{{.headers.Authorization}}"},
      {key: "user-id", value: "3e173751-8840-4b0d-8065-fbea88357cc5"}
    ]
  )

  # Order mutations
  createOrder(input: CreateOrderInput!): Empty!
  @grpc(
    url: "{{.env.OMS_GRPC_URL}}"
    method: "infrastructure.rpc.order.v1.OrderService.Create"
    body: "{{.args.input}}"
    headers: [
      {key: "Authorization", value: "{{.headers.Authorization}}"},
      {key: "user-id", value: "3e173751-8840-4b0d-8065-fbea88357cc5"}
    ]
  )

  cancelOrder(orderId: String!): Empty!
  @grpc(
    url: "{{.env.OMS_GRPC_URL}}"
    method: "infrastructure.rpc.order.v1.OrderService.Cancel"
    body: "{\"id\": \"{{.args.orderId}}\"}"
    headers: [
      {key: "Authorization", value: "{{.headers.Authorization}}"},
      {key: "user-id", value: "3e173751-8840-4b0d-8065-fbea88357cc5"}
    ]
  )

  updateDeliveryInfo(input: UpdateDeliveryInfoInput!): Empty!
  @grpc(
    url: "{{.env.OMS_GRPC_URL}}"
    method: "infrastructure.rpc.order.v1.OrderService.UpdateDeliveryInfo"
    body: "{\"order_id\": \"{{.args.input.orderId}}\", \"delivery_info\": {{.args.input.deliveryInfo}}}"
    headers: [
      {key: "Authorization", value: "{{.headers.Authorization}}"},
      {key: "user-id", value: "3e173751-8840-4b0d-8065-fbea88357cc5"}
    ]
  )

  checkout(input: CheckoutInput!): CheckoutResult!
  @grpc(
    url: "{{.env.OMS_GRPC_URL}}"
    method: "infrastructure.rpc.order.v1.OrderService.Checkout"
    body: "{\"customer_id\": \"{{.args.input.customerId}}\", \"delivery_info\": {{.args.input.deliveryInfo}}}"
    headers: [
      {key: "Authorization", value: "{{.headers.Authorization}}"},
      {key: "user-id", value: "{{.args.input.customerId}}"}
    ]
  )
}
