# yaml-language-server: $schema=https://raw.githubusercontent.com/wundergraph/cosmo/main/router/pkg/config/config.schema.json
# Cosmo Router Configuration
# https://cosmo-docs.wundergraph.com/router/configuration

version: "1"

# Router execution config (generated by `wgc router compose`)
execution_config:
  file:
    path: "./router-config.json"

# Override subgraph URLs at runtime (K8s: set in Helm deploy.env).
# Local dev: set ADMIN_SUBGRAPH_URL, CARTS_SUBGRAPH_URL, COUNTRIES_SUBGRAPH_URL or omit to use router-config.json URLs.
# https://cosmo-docs.wundergraph.com/router/proxy-capabilities/override-subgraph-config
overrides:
  subgraphs:
    admin:
      routing_url: "${ADMIN_SUBGRAPH_URL}"
    carts:
      routing_url: "${CARTS_SUBGRAPH_URL}"
    countries:
      routing_url: "${COUNTRIES_SUBGRAPH_URL}"

# Server configuration
listen_addr: "0.0.0.0:9991"

# Logging configuration
log_level: "info"

# Access logs: structured JSON in production; include operation and error details
access_logs:
  enabled: true
  level: "info"
  output:
    stdout:
      enabled: true
  router:
    fields:
      - key: "operation_name"
        value_from:
          context_field: "operation_name"
      - key: "response_error_message"
        value_from:
          context_field: "response_error_message"
      - key: "request_error"
        value_from:
          context_field: "request_error"
      - key: "subgraph_names"
        value_from:
          context_field: "operation_service_names"
  subgraphs:
    enabled: true
    fields:
      - key: "subgraph_error"
        value_from:
          context_field: "response_error_message"
      - key: "request_error"
        value_from:
          context_field: "request_error"

# Enable GraphQL Playground
playground:
  enabled: true
  path: "/"

# Enable GraphQL introspection
introspection:
  enabled: true

# GraphQL endpoint path
graphql_path: "/graphql"

# Health check endpoints
health_check_path: "/health"
readiness_check_path: "/health/ready"
liveness_check_path: "/health/live"

# CORS configuration
cors:
  allow_origins:
    - "http://localhost:3000"
    - "https://shop.shortlink.best"
  allow_methods:
    - "GET"
    - "POST"
    - "OPTIONS"
  allow_headers:
    - "Content-Type"
    - "Authorization"
    - "X-Request-ID"
  allow_credentials: true

# Forward auth headers from Oathkeeper/client to subgraphs (JWT, X-User-ID)
# https://cosmo-docs.wundergraph.com/router/proxy-capabilities/request-headers-operations
headers:
  all:
    request:
      - op: propagate
        named: Authorization
      - op: propagate
        named: X-User-ID
      - op: propagate
        named: Cookie

# Telemetry configuration
telemetry:
  metrics:
    prometheus:
      enabled: true
      path: "/metrics"
      listen_addr: "0.0.0.0:8088"

# Traffic shaping
traffic_shaping:
  router:
    max_request_body_size: "5MB"
