apiVersion: v1
kind: ConfigMap
metadata:
  name: shop-init-sql
  annotations:
    argocd.argoproj.io/sync-wave: "1"
data:
  init.sql: |
    -- shop database
    \c shop;
    CREATE SCHEMA AUTHORIZATION shop;
    ALTER DATABASE shop OWNER TO shop;

    -- Enable PostGIS extension for geospatial features (offices, delivery tracking)
    CREATE EXTENSION IF NOT EXISTS postgis;

    GRANT CONNECT ON DATABASE shop TO grafana;
    GRANT USAGE ON SCHEMA shop TO grafana;
    ALTER DEFAULT PRIVILEGES FOR ROLE shop IN SCHEMA shop GRANT SELECT ON TABLES TO grafana;
    ALTER DEFAULT PRIVILEGES FOR ROLE shop IN SCHEMA shop GRANT USAGE ON SEQUENCES TO grafana;

    -- statement_timeout applies globally to all connections (including Grafana and maintenance)
    ALTER DATABASE shop SET statement_timeout = '180s';

    -- Grant grafana access to pg_statio_user_tables via pg_read_all_stats role
    GRANT pg_read_all_stats TO grafana;
    GRANT pg_read_all_settings TO grafana;
