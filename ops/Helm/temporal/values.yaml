# Common default values for temporal.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# ==============================================================================
# Deploy configuration (required for shortlink-template http_route)
deploy:
  type: Deployment

# ==============================================================================
# Service configuration (required for shortlink-template)
service:
  type: ClusterIP
  ports:
    - name: http
      port: 8080
      protocol: TCP
      public: true

# ==============================================================================
# Istio RequestAuthentication for JWT validation
# ref: https://istio.io/latest/docs/reference/config/security/request_authentication/
requestAuthentication:
  enabled: true
  issuer: "https://shortlink.best"
  jwksUri: "http://oathkeeper-api.auth.svc.cluster.local:4456/.well-known/jwks.json"
  forwardOriginalToken: true

# ==============================================================================
# Istio AuthorizationPolicy to require valid JWT
# ref: https://istio.io/latest/docs/reference/config/security/authorization-policy/
authorizationPolicy:
  enabled: true

# ==============================================================================
# HTTPRoute: Istio Gateway → Oathkeeper → Temporal Web UI
# ADR: https://github.com/shortlink-org/auth/blob/main/docs/ADR/decisions/0001-zero-trust-authentication-flow-browser-istio-oathkeeper-bff.md
httpRoute:
  enabled: true
  parentRefs:
    - name: external-gateway
      namespace: istio-ingress
      sectionName: https
  hostnames:
    - temporal.shortlink.best
  rules:
    # All routes through Oathkeeper for JWT validation
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: oathkeeper-proxy
          namespace: auth
          port: 4455

# ==============================================================================
temporal:
  enabled: true

  fullnameOverride: temporal

  serviceAccount:
    create: true

  server:
    replicaCount: 1

    # Disable Istio sidecar injection - Temporal uses plain gRPC without mTLS
    podAnnotations:
      sidecar.istio.io/inject: "false"

    # Resource configuration for Temporal server components
    # Requests are minimal for development, limits prevent runaway usage
    resources:
      requests:
        cpu: "50m"
        memory: "128Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"

    config:
      persistence: {}

    metrics:
      serviceMonitor:
        enabled: true

        additionalLabels:
          release: prometheus-operator

    frontend:
      metrics:
        serviceMonitor:
          enabled: true

    history:
      metrics:
        serviceMonitor:
          enabled: true

    matching:
      metrics:
        serviceMonitor:
          enabled: true

    worker:
      metrics:
        serviceMonitor:
          enabled: true

  web:
    # Disable Istio sidecar injection
    podAnnotations:
      sidecar.istio.io/inject: "false"

    # Resource configuration for Temporal Web UI
    resources:
      requests:
        cpu: "25m"
        memory: "64Mi"
      limits:
        cpu: "200m"
        memory: "256Mi"

    # Disable built-in ingress - using Istio Gateway instead
    ingress:
      enabled: false

  elasticsearch:
    enabled: true
    replicas: 1

    # Disable Istio sidecar injection
    podAnnotations:
      sidecar.istio.io/inject: "false"

    # Resource configuration for Elasticsearch (visibility store)
    resources:
      requests:
        cpu: "100m"
        memory: "512Mi"
      limits:
        cpu: "1000m"
        memory: "2Gi"

  cassandra:
    enabled: true

    # Disable Istio sidecar injection
    podAnnotations:
      sidecar.istio.io/inject: "false"

    persistence:
      storageClass: local-path
      size: 1Gi

    config:
      cluster_size: 1

    # Resource configuration for Cassandra (workflow persistence)
    resources:
      requests:
        cpu: "100m"
        memory: "512Mi"
      limits:
        cpu: "1000m"
        memory: "2Gi"

    exporter:
      enabled: false

  prometheus:
    enabled: false

  grafana:
    enabled: false

# ==============================================================================
# Temporal Namespace Setup Job
# Creates application namespaces in Temporal after deployment
namespaceSetup:
  enabled: true

  # Temporal CLI image
  image:
    repository: temporalio/admin-tools
    tag: "1.25.2"
    pullPolicy: IfNotPresent

  # Temporal frontend address
  temporalAddress: "temporal-frontend:7233"

  # Service account (uses default if not specified)
  serviceAccountName: ""

  # Namespaces to create
  namespaces:
    - name: oms
      description: "Order Management System workflows"
      retentionDays: 7
    - name: delivery
      description: "Delivery Service workflows"
      retentionDays: 7

  # Resource limits for the job
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "100m"
      memory: "128Mi"
